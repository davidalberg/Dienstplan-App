generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @default(cuid())
  email      String      @unique
  password   String
  name       String?
  role       String      @default("EMPLOYEE")
  employeeId String?     @unique
  teamId     String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  auditLogs   AuditLog[]
  timesheets  Timesheet[]
  submissions MonthlySubmission[]
  team        Team?       @relation(fields: [teamId], references: [id])

  // Neue Felder für Mitarbeiter-Verwaltung
  entryDate                DateTime?
  exitDate                 DateTime?
  hourlyWage               Float?       @default(0)
  travelCostType           String       @default("NONE")
  nightPremiumEnabled      Boolean      @default(true)
  nightPremiumPercent      Float        @default(25)
  sundayPremiumEnabled     Boolean      @default(true)
  sundayPremiumPercent     Float        @default(30)
  holidayPremiumEnabled    Boolean      @default(true)
  holidayPremiumPercent    Float        @default(125)

  // Dienstplan-Zuweisung
  assignedSheetId          String?
  assignedPlanTab          String?
}

model Team {
  id                      String              @id @default(cuid())
  name                    String              @unique
  assistantRecipientEmail String?             // E-Mail des Assistenznehmers für Signatur
  assistantRecipientName  String?             // Name des Assistenznehmers für PDF
  timesheets              Timesheet[]
  members                 User[]
  submissions             MonthlySubmission[]
}

model Timesheet {
  id               String   @id @default(cuid())
  date             DateTime
  plannedStart     String?
  plannedEnd       String?
  actualStart      String?
  actualEnd        String?
  breakMinutes     Int      @default(0)
  note             String?
  absenceType      String?
  status           String   @default("PLANNED")
  employeeId       String
  teamId           String?
  month            Int
  year             Int
  lastUpdatedAt    DateTime @updatedAt
  lastUpdatedBy    String?
  source           String?
  sheetFileName    String?
  sheetId          String?
  syncVerified     Boolean  @default(false)
  backupEmployeeId String?
  team             Team?    @relation(fields: [teamId], references: [id])
  employee         User     @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@index([source, syncVerified])
  @@index([month, year, employeeId])
  @@index([date, status])
  @@index([backupEmployeeId, month, year])
}

model AuditLog {
  id         String   @id @default(cuid())
  employeeId String
  date       DateTime
  changedAt  DateTime @default(now())
  changedBy  String
  field      String?
  oldValue   String?
  newValue   String?
  employee   User     @relation(fields: [employeeId], references: [id])
}

model SyncLog {
  id            String    @id @default(cuid())
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  status        String
  message       String?
  rowsProcessed Int       @default(0)
}

model MonthlySubmission {
  id                 String    @id @default(cuid())
  month              Int
  year               Int
  employeeId         String
  teamId             String

  // Mitarbeiter-Signatur
  employeeSignature  String?   @db.Text // Base64 PNG
  employeeSignedAt   DateTime?
  employeeIp         String?

  // Assistenznehmer-Signatur
  recipientSignature String?   @db.Text // Base64 PNG
  recipientSignedAt  DateTime?
  recipientIp        String?
  signatureToken     String    @unique // Einmaliger Link-Token
  tokenExpiresAt     DateTime

  // PDF & Status
  pdfUrl             String?   // Google Drive URL
  status             String    @default("PENDING_EMPLOYEE")
  // Status: PENDING_EMPLOYEE → PENDING_RECIPIENT → COMPLETED

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  employee           User      @relation(fields: [employeeId], references: [id])
  team               Team      @relation(fields: [teamId], references: [id])

  @@unique([employeeId, month, year])
  @@index([signatureToken])
  @@index([status])
}
